<!DOCTYPE html><html>
  <head>
    <meta charset="utf-8">
    <title>How far?</title>
	<link rel="stylesheet" type="text/css" href="styles/site.css">
	<script src="javascripts/jquery-2.1.1.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
$(function(){
	var londonCoords = new google.maps.LatLng(51.507222, -0.127500);
	var map;
	var sv;
	var panorama;
	var randomPlace;
	var userLoc;
	var marker1;
	var marker2;
	var totalScore = 0;
	var usingSetCoords = false;
	var isFavourited = false;
	var currentMap = 1;
	var numOfRounds = 5;

	var actualDist;

	$("#rounds").html(numOfRounds);
	
	function toRadians(angle) {
	  return angle * Math.PI / 180;
	};

	function getDistance(p1, p2) {
	  var R = 6378.137; // Earth’s mean toRadiansius in kilometres
	  var dLat = toRadians(p2.B - p1.B);
	  var dLong = toRadians(p2.k - p1.k);
	  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
		Math.cos(toRadians(p1.B)) * Math.cos(toRadians(p2.B)) *
		Math.sin(dLong / 2) * Math.sin(dLong / 2);
	  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
	  var d = R * c;
	  return d; // returns the distance in meter
	};
		
	function setupMap(){
		$("#map-canvas").html("");
		marker1 = null;
		marker2 = null;
	map = null;
		var mapOptions = {
		streetViewControl: false,
		zoomControl: false,
		mapTypeControl: false
		};
		
	   map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
		var bounds = new google.maps.LatLngBounds(null);
		
		marker1 = new google.maps.Marker({
			position: randomPlace,
			map: map
		  });

		  //extend the bounds to include each marker's position
		  bounds.extend(marker1.position);
		  
		 marker2 = new google.maps.Marker({
			position: userLoc,
			map: map
		  });

		  //extend the bounds to include each marker's position
		 bounds.extend(marker2.position);

		map.fitBounds(bounds);
		map.panToBounds(bounds);
		google.maps.event.trigger(map, 'resize');
	}

	function checkIfFavourited(){
		for (i = 0; i < localStorage.length; i++) {
			var itemKey = localStorage.key(i);
			if (itemKey.indexOf("Panorama") > -1){
				var value = localStorage.getItem(itemKey);
				if (value == (randomPlace.k + "," + randomPlace.B)){
					 isFavourited = true;
				}
			}
		}
	}
	
	function initialize() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(setUserLoc, setLondonLoc);
			}else{
				setLondonLoc();
			}
	
		$("#roundNo").html(currentMap);
	 sv = new google.maps.StreetViewService();
		var long = ((Math.random() * 360) - 180).toFixed(6);
		var lat =  ((Math.random() * 180) - 90).toFixed(6);
		randomPlace = new google.maps.LatLng(lat, long);
		  sv.getPanoramaByLocation(randomPlace, 60000, processSVData);
	}

	function processSVData(data, status) {
		if (panorama != null){
				panorama.setVisible(false);
		}
	  if (status == google.maps.StreetViewStatus.OK) {
	  randomPlace = data.location.latLng;
	  
	  			$("#heartShape").attr("class","");
		isFavourited = false;
		checkIfFavourited();
		

			setFavourited();
		
		

	   var panoramaOptions = {
		position: randomPlace,
		addressControl: false,
		linksControl: false,
		panControl: false,
		zoomControlOptions: {
		  style: google.maps.ZoomControlStyle.SMALL
		},
		enableCloseButton: false,
		pov: {
				  heading: (Math.random() * 360),
					pitch: 0
		  }
	  };
	  	  panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), panoramaOptions);
		$("#gameSection").show();
		$("#guessSection").show();
		panorama.setPano(data.location.pano);
		panorama.setVisible(true);


	  } else {
		initialize();
	  }
	}

	$("#nextRound").click(function(){
		$("#resultSection").hide();
		$("#answerSection").hide();
		initialize();
	});

	$("#guessSubmit").click(function(){

getDistanceFromPan();


	});
	
	function setUserLoc(position){
		userLoc = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
		usingSetCoords = false;
		$("#guessLabel").html("How far are you from this place? (km)");
	}
	
		function setLondonLoc(){
		userLoc = londonCoords;
		usingSetCoords = true;
		$("#guessLabel").html("How far is London from this place? (km)");
	}

	function getDistanceFromPan() {
		 if (!isNaN($("#distGuess").val())){
			var guess = $("#distGuess").val();

			actualDist = getDistance(userLoc, randomPlace);
			var closeness = actualDist - guess; 
			var loc = "";
			if (usingSetCoords){
				loc = "London";
			}
			else {
				loc = "your location";
			}
			
			$("#ans").html("You were " + Math.abs(closeness).toFixed(0) + "km off. Actual distance from " + loc +  " was " + actualDist.toFixed(0) + "km.");
			var score = 0;
			if (closeness < 0){
				 score= ((Math.abs(guess)/actualDist)*100).toFixed(0);
				 score = score - 100;
				 score = 100 - score;
				 if(score < 0){
				 score = 0;
				}
			}
			else{
				score= ((Math.abs(guess)/actualDist)*100).toFixed(0);
			}
			totalScore += parseInt(score);
			if (isNaN(score)){
				$("#score").html("actual Dist: " + actualDist + " closeness: " + closeness + parseInt($("#score").html()) + parseInt(score));
			}else {
				$("#score").html(parseInt($("#score").html()) + parseInt(score));
			}
			$("#distGuess").val('');
			$("#gameSection").hide();
			$("#guessSection").hide();
			displayResult();
		}
	}	

	function displayResult(){
		currentMap += 1;

		$("#resultSection").show();
		
		if (currentMap <= numOfRounds){			
			setupMap();	
			$("#answerSection").show();
		}else {
			$('body').removeClass('restart').addClass('gameOver');
			$("#finalScoreSection").show();
			$("#finalScore").html(totalScore);	

		}
	}
	
	$("#heartShape").hover( function(){
				$("#heartShape").attr('fill', "#250352");	
			},
			function(){
				setFavourited();	
	});
	
			$("#mainTitle").hover( function(){
				$("#logo").attr('class', "spin");	
			},
			function(){
				$("#logo").attr('class', "");		
			});

	
	function setFavourited(){
			if(isFavourited){
		$("#heartShape").attr('fill', "#FD6E8A");
		}else {
			$("#heartShape").attr('fill', "#848D82");	
		}
	}
	
	$('#heartShape').click(function(){
		if(!isFavourited){
			var noOfFavs = localStorage.length;
			var storageKey = "Panorama " + noOfFavs;
			var coords = randomPlace.k + "," + randomPlace.B;
			
			
			localStorage.setItem(storageKey,coords);
			isFavourited = true;	
			setFavourited();
			$("#heartShape").attr("class","spin");
			var favText = $("#favText");
			favText.removeClass('favouritedHidden');
			setTimeout(function () {
			  favText.removeClass('favouritedInvis');
			}, 20);
			setTimeout(function (){
				favText.addClass('favouritedInvis');
			
				favText.one('transitionend', function(e) {

				  favText.addClass('favouritedHidden');

				});
			
			}, 600);
		} else {
			var alreadyFavText = $("#alreadyFavText");
			alreadyFavText.removeClass('favouritedHidden');
			setTimeout(function () {
			  alreadyFavText.removeClass('favouritedInvis');
			}, 20);
			setTimeout(function (){
				alreadyFavText.addClass('favouritedInvis');
			
				alreadyFavText.one('transitionend', function(e) {

				  alreadyFavText.addClass('favouritedHidden');

				});
			
			}, 600);
		}

	});

	$("#restart").click(function(){
		$('body').removeClass('gameOver').addClass('restart');
		totalScore = 0;
		currentMap = 1;
		$("#distGuess").val('');
			$("#resultSection").hide();
			$("#finalScoreSection").hide();
		initialize();
	});	
	
	initialize();
});


    </script>
  </head>
  <body>
	<header class="mainHeader">
		<a href="/">
			<h1 id="mainTitle">			
				How far
				<svg height="90" width="90" id="logo">
				  <circle cx="45" cy="45" r="42" stroke="red" stroke-width="3" fill="red"></circle>  
				  <text x="30" y="65" fill="white" font-size="70px">?</text>
				  SVG not supported.
				</svg>
			</h1>
		</a>
		<h3>Know your place.</h3>
	</header>
	<section class="navSect">
		<nav>
			<a href="/">Home</a> |
			<a href="/favourites.html">Favourites</a> 
		</nav>
	</section>
	<article id="game">
		<header class="gameHeader">
			<h2>Round <span id="roundNo"></span>/<span id="rounds"></span></h2>
		</header>
		<section id="gameSection" style="display:none;height:60%; width:100%">
			<div id="pano" style="width:100%;height:100%;float:left"></div>
		</section>
		<section id="resultSection" style="display:none; height:60%; width:100%">
		   <div id="map-canvas" style="width: 100%;height: 100%;float:left"></div>
		</section>
		<section id="favSection">
			<span id="favText" class="favourited favouritedHidden">You have added this panorama to your favourites!</span>
			<span id="alreadyFavText" class="favourited favouritedHidden">This panorama is already in your favourites!</span>
		</section>
		<section id="guessSection" class="textSection" style="display:none">
			<label for="distGuess" id="guessLabel"></label>
			<input type="number" step="500"  id="distGuess" />
			<input type="button" id="guessSubmit" class="btn" value="Guess" />
			<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" 
				id="svgHeart" x="0px" y="0px" width="400px" height="400px" viewBox="0 0 400 400" enable-background="new 0 0 400 400" xml:space="preserve">
				<path id="heartShape" xmlns="http://www.w3.org/2000/svg" fill="#848D82" d="M390.574,184.277c-2.134-6.021-1.86-4.98-3.722-10.071    
					c-12.698-31.909-45.655-45.34-76.7-39.93c-29.4,5.123-50.815,31.75-55.317,50.001c-0.01,0-0.018,0-0.028,0l0,0h-6.979v-0.018    
					h-0.001c-4.502-18.25-25.917-44.879-55.317-50.001c-31.044-5.409-64.001,8.021-76.7,39.93c-1.861,5.091-1.587,4.051-3.722,10.071    
					c-32.622,122.603,87.136,105.635,139.243,196.603v-0.045l0,0.064C303.438,289.914,423.195,306.882,390.574,184.277z">
				</path>
			</svg>
				</section>
		<section id="answerSection"  class="textSection" style="display:none">
			<p id="ans"></p>
			Total Score: <span id="score">0</span>
			<input type="button" id="nextRound" class="btn" value="Next Map" />
		</section>
		<section id="finalScoreSection" class="textSection" style="display:none">
			Final Score: <span id="finalScore"></span>
			<input type="button" id="restart" class="btn" value="Play Again?">
		</section>
	</article>
  </body>
</html>